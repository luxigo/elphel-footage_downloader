#!/bin/bash
#
# elphel-footage_downloader
#
# Copyright (c) 2014 FOXEL SA - http://foxel.ch
# Please read <http://foxel.ch/license> for more information.
#
# This file is part of the FOXEL project <http://foxel.ch>.
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
#
# Additional Terms:
#
#      You are required to preserve legal notices and author attributions in
#      that material or in the Appropriate Legal Notices displayed by works
#      containing it.
#
#      You are required to attribute the work as explained in the "Usage and
#      Attribution" section of <http://foxel.ch/license>.
#
# Author(s):
#
#      Luc Deschenaux <l.deschenaux@foxel.ch>


DESTINATION=/data/footage
LOGFILE=/var/log/footage_downloader.log
ENABLED=yes
#MAILTO=root@localhost

[ -f /etc/defaults/footage_downloader ] && . /etc/defaults/footage_downloader

[ "$ENABLED" = "yes" ] || exit 0

isParentOnOtherDevice() {                                  
  _DIRECTORY=$1                                            
  DEVICE=$(stat -c "%d" "$_DIRECTORY") || exit 1           
  DEVICE2=$(stat -c "%d" "`dirname $_DIRECTORY`") || exit 3                     
  test "$DEVICE" != "$DEVICE2"                             
}                                                          

isMounted() {              
  _MOUNTPOINT=$1           
  grep -q " $(echo $_MOUNTPOINT | sed -e 's/ /\\\\040/g') " /proc/mounts || isParentOnOtherDevice "$_MOUNTPOINT"
}                          

isMounted $DESTINATION || mount $DESTINATION
sleep 5

if isMounted $DESTINATION ; then

killtree() {
    local _pid=$2
    local _sig=$1
    kill -stop ${_pid} # needed to stop quickly forking parent from producing children between child killing and parent killing
    for _child in $(ps -o pid --no-headers --ppid ${_pid}); do
        killtree ${_sig} ${_child}
    done
    kill ${_sig} ${_pid} 2>/dev/null
}

retryinnextlife() {
  /sbin/shutdown -r +1
  killtree -9 $(cat /tmp/$$.pid)
}

trap "killtree -9 $(cat /tmp/$$.pid)" SIGINT SIGTERM EXIT

(
  echo $BASHPID > /tmp/$$.pid
  SUCCESS=0
  COUNT=0
  /usr/local/bin/footage_downloader.sh $DESTINATION 2>&1 | tee -a $LOGFILE | while read line ; do 
    echo "$line"
    if [[ "$line" =~ "rsync: read errors mapping" ]] ; then
      retryinnextlife
    fi
    if [[ "$line" =~ "exit_status" ]] ; then
      [ "${line[3]}" = "0" ] && SUCCESS=1
    fi
  done
  [ -n "$MAILTO" ] && echo $SUCCESS | mail $MAILTO -s "footage_downloader"
) &

wait

fi
